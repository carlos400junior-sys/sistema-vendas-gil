{% extends "base.html" %}
{% block conteudo %}

<div class="max-w-7xl mx-auto px-3 sm:px-4 py-6 sm:py-8 animate-in fade-in duration-700">

    <!-- CABE√áALHO -->
    <div class="flex flex-col gap-6 sm:flex-row sm:items-center sm:justify-between mb-8 sm:mb-12">
        <div>
            <h1 class="text-3xl sm:text-4xl font-black text-slate-900 tracking-tight">
                Or√ßamento de <span class="text-blue-600">Vendas</span>
            
        </div>

        <!-- CLIENTE -->
        <div class="flex items-center gap-3 bg-white p-3 rounded-2xl shadow border">
            <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white text-xl">
                üë§
            </div>
            <div>
                <span class="text-[10px] font-black text-slate-400 uppercase">Cliente</span>
                <p class="font-bold text-slate-800">
                    {{ session.get('cliente_selecionado', 'Consumidor Final') }}
                </p>
            </div>
            <a href="{{ url_for('clientes') }}" class="ml-2 text-xl">üîÑ</a>
        </div>
    </div>

    <!-- GRID PRINCIPAL -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 lg:gap-10">

        <!-- PRODUTOS -->
        <div class="xl:col-span-2 space-y-6">

            <!-- BUSCA -->
            <form method="POST" class="relative">
                <input type="text" name="pesquisa"
                    class="w-full bg-white rounded-2xl py-4 px-6 pl-14 text-base shadow border focus:ring-2 focus:ring-blue-500 outline-none"
                    placeholder="Buscar produto...">
                <span class="absolute left-5 top-1/2 -translate-y-1/2 opacity-40">üîç</span>
                <button type="submit"
                    class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 text-white px-6 py-2 rounded-xl font-bold">
                    Buscar
                </button>
                
            </form>

            {% if pecas %}
            <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                {% for peca in pecas %}
                <div class="bg-white p-4 rounded-3xl border shadow hover:shadow-xl transition flex flex-col">

                    <!-- IMAGEM -->
                    <div class="aspect-square bg-slate-100 rounded-2xl mb-3 flex items-center justify-center overflow-hidden">
                        {% if peca.foto %}
                        <img src="{{ url_for('static', filename='uploads/' + peca.foto) }}"
                             class="w-full h-full object-cover">
                        {% else %}
                        <span class="text-4xl text-slate-300">üì¶</span>
                        {% endif %}
                    </div>

                    <!-- INFO -->
                    <h3 class="font-bold text-slate-800 text-sm sm:text-base leading-tight mb-1">
                        {{ peca.nome }}
                    </h3>
                    <p class="text-blue-600 font-black text-lg mb-3">
                        R$ {{ "%.2f"|format(peca.preco) }}
                    </p>

                    <!-- FORM ADD -->
                    <form id="form-add-{{ loop.index }}" class="mt-auto space-y-3">
                        <input type="hidden" name="nome" value="{{ peca.nome }}">
                        <input type="hidden" name="preco" value="{{ peca.preco }}">
                        <input type="hidden" name="imagem" value="{{ peca.foto }}">

                        <!-- QTD -->
                        <div class="grid grid-cols-3 bg-slate-100 rounded-xl p-1">
                            <button type="button"
                                onclick="const i=this.nextElementSibling;if(i.value>1)i.stepDown()"
                                class="bg-white rounded-lg font-bold">‚àí</button>
                            <input type="number" name="quantidade" value="1" min="1" readonly
                                class="bg-transparent text-center font-bold">
                            <button type="button"
                                onclick="this.previousElementSibling.stepUp()"
                                class="bg-white rounded-lg font-bold">+</button>
                        </div>

                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-2xl py-3 font-extrabold text-sm transition">
                            üõí Adicionar
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- CARRINHO -->
        <div id="card-carrinho"
            class="fixed bottom-0 left-0 right-0 xl:static bg-white xl:rounded-3xl rounded-t-3xl
                   shadow-2xl border p-5 flex flex-col z-50 xl:z-auto
                   min-h-[260px] xl:min-h-[500px]">

            <h2 class="font-black text-xl mb-4 flex items-center gap-2">
                üõí Carrinho
            </h2>

            <div id="lista-carrinho"
                class="flex-grow overflow-y-auto space-y-2 max-h-[200px] xl:max-h-none">

                {% if orcamento %}
                {% for item in orcamento %}
                <div class="flex justify-between bg-slate-50 p-3 rounded-xl">
                    <div>
                        <p class="font-bold text-sm">{{ item.nome }}</p>
                        <span class="text-xs text-slate-400">{{ item.quantidade }}x</span>
                    </div>
                    <strong>R$ {{ "%.2f"|format(item.subtotal) }}</strong>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-center text-slate-400 text-sm py-10">
                    Adicione produtos para finalizar
                </p>
                {% endif %}
            </div>

            <!-- TOTAL -->
            <div class="border-t mt-4 pt-4 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-black uppercase text-slate-400">Total</span>
                    <span id="total-geral" class="text-2xl font-black">
                        R$ {{ total }}
                    </span>
                </div>

                <!-- FINALIZAR -->
                <form id="form-finalizar-pix" action="/gerar_nota" method="POST"
                      class="{% if not orcamento %}hidden{% endif %} space-y-3">
                    <input type="hidden" name="pagamento" value="Pix">

                    <input type="text" name="tecnico" required
                        placeholder="Nome do t√©cnico"
                        class="w-full border rounded-xl px-4 py-3 font-semibold">

                    <button type="submit" id="btn-pix"
                        class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-black">
                        ‚ö° FINALIZAR PEDIDO
                    </button>

                    <a href="{{ url_for('limpar_carrinho') }}"
                       class="block text-center text-xs text-red-500 font-bold uppercase">
                        üóëÔ∏è Esvaziar Carrinho
                    </a>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JS (mantido funcional) -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('form[id^="form-add-"]').forEach(form => {
        form.addEventListener('submit', e => {
            e.preventDefault();
            fetch("/adicionar_item", { method: "POST", body: new FormData(form) })
            .then(r => r.json())
            .then(d => atualizarCarrinho(d.carrinho, d.total));
        });
    });
});

function atualizarCarrinho(itens, total) {
    const lista = document.getElementById('lista-carrinho');
    const totalEl = document.getElementById('total-geral');
    const formPix = document.getElementById('form-finalizar-pix');

    lista.innerHTML = '';
    if (!itens.length) return;

    itens.forEach(i => {
        lista.innerHTML += `
        <div class="flex justify-between bg-slate-50 p-3 rounded-xl">
            <span>${i.nome} (${i.quantidade}x)</span>
            <strong>R$ ${parseFloat(i.subtotal).toFixed(2)}</strong>
        </div>`;
    });

    totalEl.innerText = 'R$ ' + parseFloat(total).toFixed(2);
    formPix.classList.remove('hidden');
}
</script>

{% endblock %}
